"use strict";
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="be2addca-5e65-5791-8615-38597cb27502")}catch(e){}}();
(self.webpackChunkavalanche_extension=self.webpackChunkavalanche_extension||[]).push([[4246],{82261:(e,t,r)=>{r.d(t,{$:()=>m,q:()=>h});var a=r(67294),n=r(48740),o=r(99424),i=r(35801),s=r(4674),c=r(87474),l=r(27641),d=r(91415);const u=e=>"fido"===e.type?{...e,type:d.fS.Fido}:{type:d.fS.Totp};let m=function(e){return e[e.NotInitialized=0]="NotInitialized",e[e.Initialized=1]="Initialized",e[e.Complete=2]="Complete",e[e.TotpChallenge=3]="TotpChallenge",e[e.FidoChallenge=4]="FidoChallenge",e[e.ChooseMfaMethod=5]="ChooseMfaMethod",e}({});const h=({getOidcToken:e,setIsLoading:t,onSignerTokenObtained:r})=>{const[h,p]=(0,a.useState)(""),[f,g]=(0,a.useState)(m.NotInitialized),[E,w]=(0,a.useState)(),[b,v]=(0,a.useState)(""),[y,S]=(0,a.useState)(),[C,M]=(0,a.useState)(""),[K,I]=(0,a.useState)(),[j,T]=(0,a.useState)(""),{capture:k}=(0,l.O)(),[x,U]=(0,a.useState)([]),F=(0,a.useCallback)((e=>{e.type===d.fS.Fido?(g(m.FidoChallenge),T(e.name)):e.type===d.fS.Totp?(g(m.TotpChallenge),T("")):S(d.Kj.UnsupportedMfaMethod)}),[]),_=(0,a.useCallback)((async e=>{const t=(0,i.xo)(e),r=await t.identityProve(),a=r.user_info?.configured_mfa??[];return{email:r.email??"",userId:r.identity?.sub,mfaMethods:a}}),[]),P=(0,a.useCallback)((async({expectedEmail:a,expectedUserId:s})=>{g(m.Initialized),M(""),I(""),t(!0),T("");try{const t=await e();if(!t)return k("SeedlessLoginFailed"),void S(d.Kj.FailedToFetchOidcToken);const{email:c,userId:l,mfaMethods:h}=await _(t);if(M(c),I(l),!l)return void S(d.Kj.MissingUserId);if(s&&s!==l)return void S(d.Kj.MismatchingUserId);if(!s&&a&&c!==a)return void S(d.Kj.MismatchingEmail);p(t);const f=await(0,i.dw)(t);if(!f.requiresMfa()){g(m.Complete);const e=await(0,o.r)(f);return void await(r?.(e,c,l))}const E=f.mfaSessionInfo();if(E){if(v(f.mfaId()),w(await(0,i.XX)(E)),!h.length)return S(d.Kj.NoMfaMethodsConfigured),!1;if(1===h.length){const e=h[0];if("totp"===e.type)g(m.TotpChallenge);else{if("fido"!==e.type)return S(d.Kj.UnsupportedMfaMethod),!1;g(m.FidoChallenge),T(e.name)}}else g(m.ChooseMfaMethod),U(h.map(u))}else S(d.Kj.NoMfaDetails),(0,n.Z)(new Error("MFA is required, but no details were provided"),n.p.SEEDLESS)}catch(e){S(d.Kj.UnknownError),(0,n.Z)(e,n.p.SEEDLESS)}finally{t(!1)}}),[t,e,_,k,r]),O=(0,a.useCallback)((async e=>{if(!E)return S(d.Kj.UnknownError),(0,n.Z)(new Error("Session not carried over from initial authentication"),n.p.SEEDLESS),!1;let a;t(!0),S(void 0);try{if(a=await E.totpApprove(b,e),!a.receipt?.confirmation)return S(d.Kj.TotpVerificationError),k(d.Kj.TotpVerificationError),t(!1),!1}catch{return S(d.Kj.InvalidTotpCode),k(d.Kj.InvalidTotpCode),t(!1),!1}try{const e=await(0,i.dw)(h,{mfaOrgId:"Org#db7f2cac-7bd0-4e5f-b7c2-b5881a4bb4e7",mfaId:b,mfaConf:a.receipt.confirmation}),t=await(0,o.r)(e);return t?K?(await(r?.(t,C,K)),k("TotpVaridationSuccess"),!0):(S(d.Kj.MissingUserId),!1):(k("TotpNoToken"),!1)}catch(e){return S(d.Kj.UnknownError),k("TotpVaridationFailed"),(0,n.Z)(e,n.p.SEEDLESS),!1}finally{t(!1)}}),[E,t,b,k,h,K,r,C]),D=(0,a.useCallback)((async()=>{if(!E)return S(d.Kj.UnknownError),(0,n.Z)(new Error("Session not carried over from initial authentication"),n.p.SEEDLESS),!1;t(!0),S(void 0);try{const e=await E.fidoApproveStart(b);let a;try{const t=await(0,s.B)(c.W.Authenticate,e.options);a=await e.answer(t)}catch{return S(d.Kj.FidoChallengeFailed),!1}if(!a.receipt)return S(d.Kj.FidoChallengeNotApproved),!1;let l=await(0,i.dw)(h);return l=await l.signWithMfaApproval({mfaId:b,mfaOrgId:"Org#db7f2cac-7bd0-4e5f-b7c2-b5881a4bb4e7",mfaConf:a.receipt.confirmation}),l.requiresMfa()?(t(!1),S(d.Kj.UnknownError),(0,n.Z)(new Error("MFA should not be required after approval"),n.p.SEEDLESS),!1):K?(await(r?.(await(0,o.r)(l),C,K)),!0):(S(d.Kj.MissingUserId),!1)}catch(e){return S(d.Kj.UnknownError),(0,n.Z)(e,n.p.SEEDLESS),!1}finally{t(!1)}}),[C,b,h,r,E,t,K]);return{error:y,oidcToken:h,step:f,email:C,methods:x,chooseMfaMethod:F,authenticate:P,verifyTotpCode:O,completeFidoChallenge:D,mfaDeviceName:j}}},4231:(e,t,r)=>{function a(e){return new Promise(((t,r)=>{chrome.identity.launchWebAuthFlow({url:e.toString(),interactive:!0},(e=>{if(!e)return void r(new Error("Redirect url is undefined"));if(chrome.runtime.lastError)return r(chrome.runtime.lastError);const a=new URL(e),n=new URLSearchParams(a.hash.slice(1)).get("id_token");if(!n)throw new Error("no id token");t(n)}))}))}r.d(t,{V:()=>a})},84246:(e,t,r)=>{r.r(t),r.d(t,{SeedlessAuthPopup:()=>K});var a=r(26793),n=r(68483),o=r(67294),i=r(82261),s=r(46935),c=r(64631),l=r(69518),d=r(38865),u=r(88653),m=r(29606);const h={[d.m_.Google]:u.a,[d.m_.Apple]:m.n};var p=r(75811),f=r(91415),g=r(67294);const E=({error:e})=>{const{t}=(0,a.$)();return g.createElement(n.Kqy,{sx:{width:1,px:5,justifyContent:"center",textAlign:"center",alignItems:"center",gap:1.5}},g.createElement(n.go2,{size:48,color:"error.light"}),e===f.Kj.MismatchingEmail?g.createElement(g.Fragment,null,g.createElement(n.ZT$,{variant:"h5"},t("Wrong email address.")),g.createElement(n.ZT$,{variant:"body2",color:"text.secondary"},t("Please log in with the email address you used when you created your wallet."))):g.createElement(g.Fragment,null,g.createElement(n.ZT$,{variant:"h5"},t("Sorry, we are having trouble logging you in.")),g.createElement(n.ZT$,{variant:"body2",color:"text.secondary"},t("Please verify your network connection or try again later."))))};var w=r(62440),b=r(67294);const v=({provider:e})=>{const{t}=(0,a.$)();return b.createElement(n.Kqy,{sx:{width:1,px:5,justifyContent:"center",textAlign:"center",alignItems:"center",gap:1.5}},b.createElement(n.D8x,{size:48,sx:{mb:3}}),b.createElement(n.ZT$,{variant:"h4"},b.createElement(w.c,{i18nKey:"Waiting for <bold>{{provider}}</bold> authentication to complete",components:{bold:b.createElement("b",{style:{textTransform:"capitalize"}})},values:{provider:e}})),b.createElement(n.ZT$,{variant:"body2",color:"text.secondary"},t("Do not close this window until the process is complete or you may need to restart.")))};var y=r(27785),S=r(61977),C=r(67294);const M=[f.Kj.NoMfaDetails,f.Kj.UnknownError,f.Kj.UnsupportedProvider,f.Kj.MismatchingEmail,f.Kj.MismatchingUserId,f.Kj.MissingUserId,f.Kj.FailedToFetchOidcToken,f.Kj.NoMfaMethodsConfigured,f.Kj.UnsupportedMfaMethod],K=()=>{const{request:e}=(0,l.K)(),{walletDetails:t}=(0,c.t)(),{t:r}=(0,a.$)(),[d,u]=(0,o.useState)(!1),m=(0,o.useCallback)((async(t,r,a)=>{u(!0),e({method:s.a.SEEDLESS_UPDATE_SIGNER_TOKEN,params:[t,r,a]}).then((()=>{window.close()})).finally((()=>{u(!1)}))}),[e]),f=(0,o.useMemo)((()=>(e=>{if(!e||!h[e])throw new Error(`Unsupported provider: ${e||"unknown"}`);return h[e]})(t?.authProvider)),[t]),{authenticate:g,methods:w,chooseMfaMethod:b,verifyTotpCode:K,completeFidoChallenge:I,error:j,step:T,mfaDeviceName:k}=(0,i.q)({setIsLoading:u,onSignerTokenObtained:m,getOidcToken:f});(0,o.useEffect)((()=>{(t?.userEmail||t?.userId)&&T===i.$.NotInitialized&&g({expectedEmail:t.userEmail,expectedUserId:t.userId})}),[g,t?.userEmail,T,t?.userId]);const x=j&&M.includes(j);return C.createElement(C.Fragment,null,w.length>1&&T===i.$.ChooseMfaMethod&&C.createElement(S.d,{mfaChoice:{availableMethods:w},onChosen:b}),!x&&T===i.$.TotpChallenge&&C.createElement(p.v,{error:j,isLoading:d,onSubmit:K}),!x&&T===i.$.FidoChallenge&&C.createElement(y.a,{error:j,isLoading:d,deviceName:k,completeFidoChallenge:I}),!x&&T===i.$.Initialized&&C.createElement(v,{provider:t?.authProvider}),x&&C.createElement(n.Kqy,{sx:{height:1,width:1,px:2,py:2}},C.createElement(n.Kqy,{sx:{flexGrow:1,justifyContent:"center",alignItems:"center"}},C.createElement(E,{error:j})),C.createElement(n.zxk,{color:"primary",size:"large",onClick:window.close,fullWidth:!0},r("Close"))))}},29606:(e,t,r)=>{r.d(t,{n:()=>n});var a=r(4231);async function n(){const e="https://"+chrome.runtime.id+".chromiumapp.org",t=new URL("https://appleid.apple.com/auth/authorize");return t.searchParams.set("client_id","org.avalabs.corewallet.extension"),t.searchParams.set("nonce",crypto.randomUUID()),t.searchParams.set("response_type","code id_token"),t.searchParams.set("state",e),t.searchParams.set("redirect_uri","https://seedless-api.avax.network/v1/redirectAppleAuth"),t.searchParams.set("scope","email"),t.searchParams.set("response_mode","form_post"),(0,a.V)(t)}},88653:(e,t,r)=>{r.d(t,{a:()=>n});var a=r(4231);async function n(){const e=chrome.runtime.getManifest();if(!e.oauth2||!e.oauth2.scopes)throw new Error("Oauth not configured");const t="https://"+chrome.runtime.id+".chromiumapp.org",r=new URL("https://accounts.google.com/o/oauth2/auth");return r.searchParams.set("client_id",e.oauth2.client_id),r.searchParams.set("response_type","id_token"),r.searchParams.set("redirect_uri",t),r.searchParams.set("scope",e.oauth2.scopes.join(" ")),(0,a.V)(r)}},35801:(e,t,r)=>{r.d(t,{Uu:()=>o,XX:()=>s,dw:()=>c,xo:()=>i});var a=r(88004);function n(){return a.envs.prod}function o(){return"Org#db7f2cac-7bd0-4e5f-b7c2-b5881a4bb4e7"}function i(e){return new a.OidcClient(n(),"Org#db7f2cac-7bd0-4e5f-b7c2-b5881a4bb4e7",e)}async function s(e){return new a.SignerSession(await a.SignerSessionManager.createFromSessionInfo(n(),"Org#db7f2cac-7bd0-4e5f-b7c2-b5881a4bb4e7",e))}async function c(e,t){const r=i(e);return await r.sessionCreate(["sign:*","manage:*","export:*"],{auth_lifetime:300,refresh_lifetime:7776e3,session_lifetime:31536e3},t)}},99424:(e,t,r)=>{r.d(t,{r:()=>n});var a=r(88004);const n=async e=>{const t=e.data();return(await a.SignerSessionManager.createFromSessionInfo(a.envs.prod,"Org#db7f2cac-7bd0-4e5f-b7c2-b5881a4bb4e7",t)).storage.retrieve()}}}]);
//# debugId=be2addca-5e65-5791-8615-38597cb27502
